# vLLM Server 配置文件 - 华为昇腾 NPU 版本
# 适用于 ARM64 架构 + 华为昇腾 NPU 环境
# For Huawei Ascend NPU (ARM64 + Ascend NPU)

services:

  mineru-vllm-server:
    image: lpdswing/mineru-web-backend-npu:v2.6.8
    container_name: mineru-vllm-server
    restart: always
    ports:
      - 30000:30000
    # 昇腾 NPU 设备配置
    # Ascend NPU device configuration
    devices:
      - /dev/davinci0:/dev/davinci0
      - /dev/davinci_manager:/dev/davinci_manager
      - /dev/devmm_svm:/dev/devmm_svm
      - /dev/hisi_hdc:/dev/hisi_hdc
    volumes:
      - /usr/local/Ascend/driver:/usr/local/Ascend/driver:ro
    environment:
      MINERU_MODEL_SOURCE: local
    entrypoint: mineru-vllm-server
    volumes:
      - ./mineru.json:/root/mineru.json
      - ./models2.0:/models
    command:
      --host 0.0.0.0
      --port 30000
      # NPU 内存利用率配置 (根据您的 NPU 显存调整)
      # --gpu-memory-utilization 0.5
      # 如果使用多个 NPU，可以启用数据并行模式
      # --data-parallel-size 2  # 多 NPU 并行处理
      # 如果遇到显存不足，降低 KV cache 大小
      # --gpu-memory-utilization 0.4
    ulimits:
      memlock: -1
      stack: 67108864
    ipc: host
    networks:
      - mineru-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:30000/health || exit 1"]
